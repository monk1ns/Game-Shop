<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Game Store</title>
    <link rel="stylesheet" href="product.css">
    <link rel="stylesheet" href="nav.css">
</head>
<body>
    <header class="header">
        <a href="index.html" class="Logo">Logo</a>
        <nav class="navbar">
            <a href="index.html">HOME</a>
            <a href="product.html">BUY</a>
            <a href="about.html">ABOUT</a>
            <a href="login.html" id="auth-link">LOGIN</a>
            <a href="cart.html" class="icon-cart-link">
                <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 4h1.5L9 16m0 0h8m-8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm-8.5-3h9.25L19 7H7.312"/>
                </svg>
            </a>
        </nav>
    </header>

    <div class="products-container">
        <div class="sort-and-search-container">
            <form id="sortForm">
                <div class="sort-options">
                    <label for="sortOption">Sort by:</label>
                    <select id="sortOption">
                        <option value="default">Default</option>
                        <option value="price-asc">Price: Low to High</option>
                        <option value="price-desc">Price: High to Low</option>
                        <option value="name-asc">Name: A to Z</option>
                        <option value="name-desc">Name: Z to A</option>
                    </select>
                </div>
            </form>
            <div class="search-input">
                <input type="text" id="searchInput" placeholder="Search by name...">
                <button type="button" onclick="searchProducts(document.getElementById('searchInput').value)">Search</button>
            </div>
            <div class="price-input">
                <input type="number" id="maxPriceInput" placeholder="Max price">
                <button type="button" onclick="filterByPrice()">Filter</button>
            </div>
        </div>
        <section class="products"></section>
    </div>

    <!-- Edit Product Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>Edit Product</h2>
            <form id="editForm">
                <label for="editTitle">Title:</label>
                <input type="text" id="editTitle" name="title">
                <label for="editDescription">Description:</label>
                <textarea id="editDescription" name="description"></textarea>
                <label for="editPrice">Price:</label>
                <input type="number" id="editPrice" name="price" step="0.01">
                <button type="button" onclick="saveProductChanges()">Save</button>
            </form>
        </div>
    </div>

    <script>
        let products = [];
        let currentProductId = null;

        function addToCart(product) {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            cart.push(product);
            localStorage.setItem('cart', JSON.stringify(cart));
            alert(`${product.title} added to cart`);
        }

        async function loadProducts() {
            try {
                const response = await fetch('http://127.0.0.1:5000/products');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                products = await response.json();
                displayProducts(products);
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        function displayProducts(productsToDisplay) {
            const productsContainer = document.querySelector('.products');
            productsContainer.innerHTML = '';

            productsToDisplay.forEach(product => {
                const productItem = document.createElement('div');
                productItem.classList.add('product-item');
                productItem.dataset.productId = product._id.$oid;

                const img = document.createElement('img');
                img.src = product.imageSrc;
                img.alt = product.title;

                const productInfo = document.createElement('div');
                productInfo.classList.add('product-info');

                const title = document.createElement('h2');
                title.textContent = product.title;

                const price = document.createElement('p');
                price.textContent = `â‚¬${product.price.toFixed(2)}`;

                const description = document.createElement('p');
                description.textContent = product.description;

                const addToCartButton = document.createElement('button');
                addToCartButton.textContent = 'Add to Cart';
                addToCartButton.onclick = () => addToCart(product);

                productInfo.appendChild(title);
                productInfo.appendChild(price);
                productInfo.appendChild(description);
                productInfo.appendChild(addToCartButton);

                productItem.appendChild(img);
                productItem.appendChild(productInfo);

                productsContainer.appendChild(productItem);

                // Check if user is authenticated to show edit and delete buttons
                checkAuthStatus();
            });

            // Check if there was a product being edited before page reload
            if (currentProductId) {
                openEditModal(products.find(p => p._id.$oid === currentProductId));
            }
        }

        function sortProducts(criteria) {
            let sortedProducts;
            if (criteria === 'price-asc') {
                sortedProducts = products.slice().sort((a, b) => a.price - b.price);
            } else if (criteria === 'price-desc') {
                sortedProducts = products.slice().sort((a, b) => b.price - a.price);
            } else if (criteria === 'name-asc') {
                sortedProducts = products.slice().sort((a, b) => a.title.localeCompare(b.title));
            } else if (criteria === 'name-desc') {
                sortedProducts = products.slice().sort((a, b) => b.title.localeCompare(a.title));
            } else {
                sortedProducts = products;
            }
            displayProducts(sortedProducts);
        }

        function searchProducts(query) {
            const filteredProducts = products.filter(product =>
                product.title.toLowerCase().includes(query.toLowerCase())
            );
            displayProducts(filteredProducts);
        }

        function filterByPrice() {
            const maxPrice = parseFloat(document.getElementById('maxPriceInput').value);

            const filteredProducts = products.filter(product => {
                if (!isNaN(maxPrice)) {
                    return product.price <= maxPrice;
                } else {
                    return true;
                }
            });

            displayProducts(filteredProducts);
        }

        function checkAuthStatus() {
            const authLink = document.getElementById('auth-link');
            const token = getCookie('token');

            if (token) {
                authLink.textContent = 'LOGOUT';
                authLink.onclick = logout;

                // Show edit and delete buttons for authenticated users
                const productItems = document.querySelectorAll('.product-item');
                productItems.forEach(item => {
                    if (!item.querySelector('button.edit')) {
                        const editButton = document.createElement('button');
                        editButton.textContent = 'Edit';
                        editButton.classList.add('edit');
                        editButton.onclick = () => editProduct(item.dataset.productId);

                        const deleteButton = document.createElement('button');
deleteButton.textContent = 'Delete';
deleteButton.classList.add('delete');
deleteButton.onclick = () => deleteProduct(item.dataset.productId);
item.appendChild(editButton);
                    item.appendChild(deleteButton);
                }
            });
        } else {
            authLink.textContent = 'LOGIN';
            authLink.onclick = login;
        }
    }

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function login() {
        // Logic for login
    }

    function logout() {
        // Logic for logout
    }

    function editProduct(productId) {
        const product = products.find(p => p._id.$oid === productId);
        if (product) {
            openEditModal(product);
        } else {
            alert('Product not found.');
        }
    }

    function openEditModal(product) {
        currentProductId = product._id.$oid;
        document.getElementById('editTitle').value = product.title;
        document.getElementById('editDescription').value = product.description;
        document.getElementById('editPrice').value = product.price;
        document.getElementById('editModal').style.display = 'flex'; // Change display to flex
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    function saveProductChanges() {
        const updatedProduct = {
            title: document.getElementById('editTitle').value,
            description: document.getElementById('editDescription').value,
            price: parseFloat(document.getElementById('editPrice').value)
        };

        fetch(`http://127.0.0.1:5000/products/${currentProductId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': getCookie('token')
            },
            body: JSON.stringify(updatedProduct)
        })
        .then(response => {
            if (response.ok) {
                alert('Product updated successfully.');
                closeEditModal();
                loadProducts(); // Reload products after update
            } else {
                throw new Error('Failed to update product');
            }
        })
        .catch(error => {
            console.error('Error updating product:', error);
            alert('Failed to update product. Please try again later.');
        });
    }

    // Close modal when clicking on the close button
    document.querySelector('.close').onclick = closeEditModal;

    // Close modal when clicking outside the modal
    window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target === modal) {
            closeEditModal();
        }
    };

    function deleteProduct(productId) {
        fetch(`http://127.0.0.1:5000/products/${productId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': getCookie('token')
            }
        })
        .then(response => {
            if (response.ok) {
                alert(`Product with ID ${productId} deleted successfully.`);
                loadProducts(); // Reload products after deletion
            } else {
                throw new Error('Failed to delete product');
            }
        })
        .catch(error => {
            console.error('Error deleting product:', error);
            alert('Failed to delete product. Please try again later.');
        });
    }

    // Load products on page load
    window.onload = () => {
        loadProducts();

        // Event listener for sorting products
        const sortSelect = document.getElementById('sortOption');
        sortSelect.addEventListener('change', (event) => {
            sortProducts(event.target.value);
        });

        // Event listener for searching products
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', (event) => {
            const query = event.target.value;
            if (query.trim()) {
                searchProducts(query);
            } else {
                loadProducts(); // Reload all products if search input is empty
            }
        });
    };
</script>
